name: Update Evo-SDK Dependency and Package Version

on:
  schedule:
    - cron: '0 12 * * *' # Run daily at 1200 UTC
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update-evo-sdk:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Step 2: Set up Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 3: Install dependencies
      - name: Install Dependencies
        run: npm install

      # Step 4: Check and Update Dependency
      - name: Check and Update Evo-SDK Dependency
        id: update_deps
        run: |
          set -e  # Stop execution on any error

          # Get current version of @dashevo/evo-sdk in package.json
          CURRENT_EVOSDK_VERSION=$(jq -r '.dependencies["@dashevo/evo-sdk"]' package.json)

          # Extract the version prefix (e.g., ^, ~, or empty)
          EVOSDK_PREFIX=$(echo "$CURRENT_EVOSDK_VERSION" | grep -o '^[^0-9]*')
          EVOSDK_VERSION_NUMBER=$(echo "$CURRENT_EVOSDK_VERSION" | grep -o '[0-9].*')

          # Get latest version from npm
          LATEST_EVOSDK_VERSION=$(npm show @dashevo/evo-sdk version)
          LATEST_MINOR_PATCH=$(echo "$LATEST_EVOSDK_VERSION" | cut -d. -f2,3)

          echo "Current evo-sdk version: $CURRENT_EVOSDK_VERSION"
          echo "Latest evo-sdk version: $LATEST_EVOSDK_VERSION"

          # Update dependency if version differs
          if [ "$EVOSDK_VERSION_NUMBER" != "$LATEST_EVOSDK_VERSION" ]; then
            jq --arg version "$EVOSDK_PREFIX$LATEST_EVOSDK_VERSION" '.dependencies["@dashevo/evo-sdk"] = $version' package.json > package.json.tmp && mv package.json.tmp package.json

            # Update package version (keep major, sync minor and patch with evo-sdk)
            CURRENT_PACKAGE_VERSION=$(jq -r '.version' package.json)
            CURRENT_MAJOR_VERSION=$(echo "$CURRENT_PACKAGE_VERSION" | cut -d. -f1)
            NEW_PACKAGE_VERSION="$CURRENT_MAJOR_VERSION.$LATEST_MINOR_PATCH"

            jq '.version = "'"$NEW_PACKAGE_VERSION"'"' package.json > package.json.tmp && mv package.json.tmp package.json
            echo "Updated package.json version to $NEW_PACKAGE_VERSION"

            npm install @dashevo/evo-sdk

            echo "needs_update=true" >> $GITHUB_ENV
          else
            echo "Dependency is up-to-date"
            echo "needs_update=false" >> $GITHUB_ENV
          fi

      # Step 5: Create Pull Request
      - name: Create Pull Request
        if: env.needs_update == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: update-deps-and-version
          base: main
          title: "chore: update @dashevo/evo-sdk and sync version"
          body: |
            This pull request updates `@dashevo/evo-sdk` to the latest version and syncs the package version, aligning the minor and patch versions with `@dashevo/evo-sdk`.
          commit-message: "chore: update @dashevo/evo-sdk and sync version"
          reviewers: "thephez"
